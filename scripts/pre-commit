#!/usr/bin/env node

/**
 * Pre-commit Hook for mbkauthe
 * Cross-platform script that runs tests before allowing commits
 * Works on Windows, Mac, and Linux
 */

import { spawn, execSync } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname, resolve } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const rootDir = resolve(__dirname, '../');

console.log('üöÄ Starting dev server for tests...\n');

// Start dev server
const devProcess = spawn('npm', ['run', 'dev'], {
  cwd: rootDir,
  stdio: 'inherit',
  shell: true,
});

// Wait a few seconds for the dev server to start
const wait = ms => new Promise(res => setTimeout(res, ms));

(async () => {
  await wait(4000); // Adjust if your server needs more/less time
  console.log('üß™ Running tests before commit...\n');
  let testPassed = false;
  try {
    execSync('npm test', {
      cwd: rootDir,
      stdio: 'inherit',
    });
    testPassed = true;
  } catch (error) {
    testPassed = false;
  }

  // Kill dev server
  if (devProcess && !devProcess.killed) {
    if (process.platform === 'win32') {
      spawn('taskkill', ['/pid', devProcess.pid, '/f', '/t']);
    } else {
      devProcess.kill('SIGTERM');
    }
  }

  if (testPassed) {
    console.log('\n‚úÖ Tests passed! Proceeding with commit.\n');
    process.exit(0);
  } else {
    console.log('\n‚ùå Tests failed! Commit aborted.');
    console.log('Please fix the failing tests and try again.\n');
    process.exit(1);
  }
})();
