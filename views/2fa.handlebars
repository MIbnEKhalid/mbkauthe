<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Log in to portal.mbktech.org to access your resources and manage projects securely.">
    <meta name="keywords" content="MBK Tech Studio, Web-Portal, Web, Portal, Admin-Panel, Admin, login">
    <meta property="og:title" content="Login | MBK Tech Studio" />
    <meta property="og:image" content="https://mbktech.org/Assets/Images/Icon/logo.png" />
    <meta property="og:url" content="/mbkauthe/2fa">
    <title>2FA | MBK Tech Studio Portal</title>
    <link rel="icon" type="image/x-icon" href="https://mbktech.org/Assets/Images/Icon/dgicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {{> sharedStyles}}
</head>

<body>
    <header>
        <div class="header-container">
            <a class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 90" class="iconAboveSlogan">
                    <g id="8db2a7f9-6efc-4f7e-ae5b-8ba33875da43" transform="matrix(2.8125,0,0,2.8125,0,0)" stroke="none"
                        fill="#00b894">
                        <path
                            d="M0 32h32V0H0v32zm19.377-19.492l6.936-6.936v20.855h-6.936V12.508zM5.688 5.572l6.936 6.936v13.919H5.688V5.572z">
                        </path>
                    </g>
                </svg>
                <span class="logo-text">{{appName}} <span class="logo-comp">mbktech</span></span>
            </a>
        </div>
    </header>

    {{> showmessage}}

    <section class="login-container">

        <i class="fas fa-robot ai-element"></i>
        <i class="fas fa-microchip ai-element"></i>
        <i class="fas fa-user-astronaut ai-element"></i>
        <i class="fas fa-satellite-dish ai-element"></i>
        <i class="fas fa-cloud ai-element"></i>
        <i class="fas fa-shield-alt ai-element"></i>

        <div class="login-box">
            <h1 class="login-title">Two Factor Authorization</h1>

            <form id="loginForm" method="POST">
                <input type="hidden" name="_csrf" value="{{csrfToken}}">
                <div class="form-group token-container" id="tokenCon">
                    <input id="token" class="form-input" type="text" name="token" placeholder=" " pattern="\d{6}"
                        title="Token must be exactly 6 digits" maxlength="6" minlength="6" />
                    <label class="form-label">2FA Token</label>
                    <i class="fas fa-info-circle input-icon" onclick="tokeninfo()"></i>
                </div>


                <button type="submit" class="btn-login" id="loginButton">
                    <span id="loginButtonText">Verify</span>
                </button>

                <p class="terms-info">
                    By logging in, you agree to our
                    <a href="https://portal.mbktech.org/info/Terms&Conditions" target="_blank"
                        class="terms-link">Terms & Conditions</a>
                    and
                    <a href="https://portal.mbktech.org/info/PrivacyPolicy" target="_blank"
                        class="terms-link">Privacy Policy</a>.
                </p>
            </form>
        </div>
    </section>

    <!-- Version Info -->
    <div class="version-info">
        v{{version}}
    </div>

    <script>
        function tokeninfo() {
            showMessage(`The 2FA token is a 6-digit code generated by your authenticator app (such as Google Authenticator, Microsoft Authenticator, or Authy). Enter the code shown in your app to complete login. If you have not set up 2FA or are having trouble, please contact support.`, `What is the 2FA token?`);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = document.getElementById('token').value;
            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');

            loginButton.disabled = true;
            loginButtonText.textContent = 'Verifying...';

            try {
                const response = await fetch('/mbkauthe/api/verify-2fa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token,
                        _csrf: csrfToken
                    })
                });
                const data = await response.json();
                if (data.success) {
                    loginButtonText.textContent = 'Success! Redirecting...';
                    window.location.href = data.redirectUrl || '{{{ customURL }}}';
                } else {
                    loginButton.disabled = false;
                    loginButtonText.textContent = 'Verify';
                    showMessage(data.message, 'Error');
                }
            } catch (error) {
                loginButton.disabled = false;
                loginButtonText.textContent = 'Verify';
                showMessage('Failed to verify token. Please try again.', 'Error');
            }
        });

        // Auto focus on empty token field
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            const tokenInput = document.getElementById('token');

            if (tokenFromUrl) {
                tokenInput.value = tokenFromUrl;
            }

            // Automatically focus the token input field
            tokenInput.focus();
        });

    </script>
</body>

</html>