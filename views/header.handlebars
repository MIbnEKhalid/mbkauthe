<header>
    <div class="header-container">
        <a class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 90" class="iconAboveSlogan">
                <g id="8db2a7f9-6efc-4f7e-ae5b-8ba33875da43" transform="matrix(2.8125,0,0,2.8125,0,0)" stroke="none"
                    fill="#00b894">
                    <path
                        d="M0 32h32V0H0v32zm19.377-19.492l6.936-6.936v20.855h-6.936V12.508zM5.688 5.572l6.936 6.936v13.919H5.688V5.572z">
                    </path>
                </g>
            </svg>
            <span class="logo-text">{{#if appName}}{{appName}}{{else}}{{#if app}}{{app}}{{else}}mbkauthe{{/if}}{{/if}} <span class="logo-comp">mbktech</span></span>
        </a>

        <div class="header-actions">
            {{#if userLoggedIn}}
            <div class="profile-menu">
                <button class="profile-trigger" type="button" aria-expanded="false" aria-haspopup="true">
                    <img src="/mbkauthe/user/profilepic?u={{username}}" alt="Profile" class="profile-avatar">
                </button>
                <div class="profile-dropdown" role="menu">
                    <a class="profile-item" role="menuitem" title="{{username}}">
                        <span>@{{username}}</span>
                    </a>
                    <a class="profile-item" href="https://portal.mbktech.org/user/settings" role="menuitem" title="Settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                    <a class="profile-item" href="/mbkauthe/accounts" role="menuitem" title="Switch or Add another Account">
                        <i class="fa fa-user-group"></i>
                        <span>Switch account</span>
                    </a>
                    <button class="profile-item" type="button" data-action="logout" role="menuitem" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
            {{else}}
            <a class="btn-login" style="text-decoration: none;" href="/mbkauthe/login"><i class="fas fa-sign-in-alt"></i>  Login</a>
            {{/if}}
        </div>
    </div>
</header>

<script>
    (() => {
        const trigger = document.querySelector('header .profile-trigger');
        const dropdown = document.querySelector('header .profile-dropdown');

        if (!trigger || !dropdown) {
            return;
        }

        const closeMenu = () => {
            dropdown.classList.remove('open');
            trigger.setAttribute('aria-expanded', 'false');
        };

        trigger.addEventListener('click', (event) => {
            event.stopPropagation();
            const isOpen = dropdown.classList.toggle('open');
            trigger.setAttribute('aria-expanded', String(isOpen));
        });

        document.addEventListener('click', (event) => {
            if (!dropdown.contains(event.target) && !trigger.contains(event.target)) {
                closeMenu();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeMenu();
            }
        });

        const logoutButton = dropdown.querySelector('[data-action="logout"]');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                const originalLabel = logoutButton.textContent;
                logoutButton.disabled = true;
                logoutButton.textContent = 'Logging out...';

                try {
                    const response = await fetch('/mbkauthe/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    const result = await response.json().catch(() => ({}));

                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert(result.message || 'Logout failed. Please try again.');
                    }
                } catch (error) {
                    console.error('[mbkauthe] Error during logout:', error);
                    alert('Logout failed. Please try again.');
                } finally {
                    logoutButton.disabled = false;
                    logoutButton.textContent = originalLabel;
                    closeMenu();
                }
            });
        }
    })();
</script>